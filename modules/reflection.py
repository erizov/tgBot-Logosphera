"""
–ú–æ–¥—É–ª—å —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏.
"""

from typing import Dict, Any, List, Tuple
import random


class ReflectionModule:
    """–ú–æ–¥—É–ª—å —Å–∏—Å—Ç–µ–º—ã —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏."""

    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è."""
        self.reflection_types = {
            "binary": [
                "–ü–æ–Ω—è–ª–∏ –ª–∏ –≤—ã –∑–Ω–∞—á–µ–Ω–∏–µ –∏–¥–∏–æ–º—ã?",
                "–°–º–æ–∂–µ—Ç–µ –ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ—ë –≤ —Ä–µ—á–∏?",
                "–û—Ü–µ–Ω–∏–ª–∏ –ª–∏ –≤—ã –Ω–æ–≤—É—é –∏–¥–∏–æ–º—É?",
            ],
            "short": [
                "–ß—Ç–æ –±—ã–ª–æ —Å–∞–º—ã–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º?",
                "–ö–∞–∫ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–Ω–∞–Ω–∏–µ?",
                "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ –≤—ã —É–∑–Ω–∞–ª–∏?",
            ],
            "long": [
                "–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ, –∫–∞–∫ —ç—Ç–∞ –∏–¥–∏–æ–º–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –≤–∞—à–µ–π –∂–∏–∑–Ω—å—é",
                "–ö–∞–∫–∏–µ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏ –æ–Ω–∞ –≤—ã–∑—ã–≤–∞–µ—Ç?",
                "–ö–∞–∫ –±—ã –≤—ã –æ–±—ä—è—Å–Ω–∏–ª–∏ —ç—Ç—É –∏–¥–∏–æ–º—É –¥—Ä—É–≥—É?",
            ],
        }

    def get_reflection_question(self, idiom: Dict[str, Any]
                                 ) -> Tuple[str, str]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞ –¥–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏.

        Args:
            idiom: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–¥–∏–æ–º—ã

        Returns:
            –ö–æ—Ä—Ç–µ–∂: (—Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞, —Ç–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞)
        """
        # –í—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø –≤–æ–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        question_type = random.choice(list(self.reflection_types.keys()))
        question = random.choice(self.reflection_types[question_type])

        text = f"üí≠ *–†–µ—Ñ–ª–µ–∫—Å–∏—è*\n\n{question}\n\n"
        text += f"–ò–¥–∏–æ–º–∞: *{idiom['expression']}*"

        return question_type, text

    def get_reflection_keyboard(self) -> List[List[Dict[str, str]]]:
        """
        –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏.

        Returns:
            –°–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫
        """
        return [
            [
                {"text": "‚úÖ –î–∞", "callback_data": "reflection_yes"},
                {"text": "‚ùå –ù–µ—Ç", "callback_data": "reflection_no"},
            ],
            [
                {"text": "üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –æ—Ç–≤–µ—Ç", "callback_data": "reflection_text"},
            ],
            [
                {"text": "‚è≠ –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å", "callback_data": "skip_reflection"},
                {"text": "üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "callback_data": "main_menu"},
            ],
        ]

    def format_reflection_stats(self, stats: Dict[str, int]) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏.

        Args:
            stats: –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π

        Returns:
            –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
        """
        if not stats:
            return "üìä –í—ã –µ—â—ë –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —Ä–µ—Ñ–ª–µ–∫—Å–∏—é."

        text = "üìä *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ—Ñ–ª–µ–∫—Å–∏–∏:*\n\n"
        for ref_type, count in stats.items():
            type_name = {
                "binary": "–ë–∏–Ω–∞—Ä–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã",
                "short": "–ö—Ä–∞—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã",
                "long": "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –æ—Ç–≤–µ—Ç—ã",
            }.get(ref_type, ref_type)
            text += f"{type_name}: {count}\n"

        return text
